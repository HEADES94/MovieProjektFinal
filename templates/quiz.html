{% extends "base.html" %}

{% block title %}Quiz: {{ movie.title }}{% endblock %}

{% block content %}
<div class="quiz-container glass-card fade-in">
    <!-- Quiz Header -->
    <div class="quiz-header glass-card">
        <div class="quiz-movie-info">
            <img src="{{ movie.poster_url }}" alt="{{ movie.title }}" class="quiz-movie-poster">
            <div>
                <h1 class="gradient-text">Quiz: {{ movie.title }}</h1>
            </div>
        </div>
    </div>

    <!-- Quiz Content -->
    <div id="quizContent">
        {% if questions %}
            <!-- Difficulty Selection -->
            <div id="difficultySelection" class="difficulty-section">
                <h3>W√§hle die Schwierigkeit:</h3>
                <div class="difficulty-buttons">
                    <button class="btn-difficulty easy" data-difficulty="leicht">Leicht</button>
                    <button class="btn-difficulty medium" data-difficulty="mittel">Mittel</button>
                    <button class="btn-difficulty hard" data-difficulty="schwer">Schwer</button>
                </div>
            </div>

            <!-- Question Section -->
            <div class="question-section glass-card" style="display: none;">
                <div class="quiz-progress">
                    <div class="progress-bar">
                        <div class="progress" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">
                        <span class="question-counter">Frage 1/{{ questions|length }}</span>
                        <span class="current-score">0 Punkte</span>
                        <span class="difficulty-display"></span>
                    </div>
                </div>

                <form id="quizForm" method="post">
                    {% for question in questions %}
                    <div class="question-container" data-question-id="{{ loop.index0 }}" style="display: {% if loop.first %}block{% else %}none{% endif %}">
                        <h3 class="question-text">{{ question.question }}</h3>
                        <div class="answers-grid">
                            {% set question_index = loop.index0 %}
                            {% set all_answers = ([question.correct_answer] + question.wrong_answers)|shuffle %}
                            {% for answer in all_answers %}
                            <div class="answer-option">
                                <input type="radio"
                                       name="answer{{ question_index }}"
                                       id="q{{ question_index }}a{{ loop.index0 }}"
                                       value="{{ answer }}"
                                       required>
                                <label for="q{{ question_index }}a{{ loop.index0 }}">{{ answer }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="correct{{ loop.index0 }}" value="{{ question.correct_answer }}">
                        <input type="hidden" name="difficulty" id="selectedDifficulty">
                    </div>
                    {% endfor %}

                    <div class="quiz-navigation">
                        <button type="button" id="prevQuestion" class="btn-secondary" style="display: none;">Zur√ºck</button>
                        <button type="button" id="nextQuestion" class="btn-primary">Weiter</button>
                        <button type="submit" id="submitQuiz" class="btn-primary" style="display: none;">Quiz abschlie√üen</button>
                    </div>
                </form>
            </div>
        {% else %}
            <div class="no-questions-message">
                <p>Leider sind f√ºr diesen Film noch keine Quizfragen verf√ºgbar.</p>
                <a href="{{ url_for('quiz_home') }}" class="btn-primary">Zur√ºck zur Quiz-√úbersicht</a>
            </div>
        {% endif %}
    </div>

    <!-- Results Section -->
    <div id="results" class="results-section glass-card" style="display: none;">
        <h2>Quiz Ergebnis</h2>
        <div class="score-display">
            <div class="score-number">0</div>
            <div class="score-text">Punkte</div>
        </div>
        <div class="achievement-unlocked" style="display: none;">
            <h3>üèÜ Achievement freigeschaltet!</h3>
            <p class="achievement-name"></p>
        </div>
        <div class="action-buttons">
            <a href="{{ url_for('movie_quiz', movie_id=movie.id) }}" class="btn-secondary">Erneut versuchen</a>
            <a href="{{ url_for('quiz_home') }}" class="btn-primary">Zur√ºck zur √úbersicht</a>
        </div>
    </div>
</div>

<style>
.quiz-container {
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
}

.difficulty-section {
    text-align: center;
    margin-bottom: 30px;
}

.difficulty-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
}

.btn-difficulty {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.btn-difficulty.easy {
    background-color: #4CAF50;
    color: white;
}

.btn-difficulty.medium {
    background-color: #FFC107;
    color: black;
}

.btn-difficulty.hard {
    background-color: #F44336;
    color: white;
}

.btn-difficulty:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.quiz-movie-info {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-bottom: 20px;
}

.quiz-movie-poster {
    width: 100px;
    height: auto;
    border-radius: 8px;
}

.question-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.question-text {
    text-align: center;
    font-size: 1.2em;
    margin-bottom: 20px;
    color: var(--primary-color);
}

.answers-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-top: 20px;
    width: 100%;
}

.answer-option {
    position: relative;
}

.answer-option input[type="radio"] {
    display: none;
}

.answer-option label {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    min-height: 60px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    word-wrap: break-word;
    height: 100%;
}

.answer-option input[type="radio"]:checked + label {
    background: rgba(var(--primary-color-rgb), 0.2);
    border: 2px solid var(--primary-color);
}

.answer-option.correct label {
    background: rgba(76, 175, 80, 0.2) !important;
    border: 2px solid #4CAF50 !important;
}

.answer-option.incorrect label {
    background: rgba(244, 67, 54, 0.2) !important;
    border: 2px solid #F44336 !important;
}

.quiz-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
}

.difficulty-display {
    font-weight: bold;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
}

.progress-text {
    display: flex;
    justify-content: space-between;
    color: #666;
    font-size: 14px;
}

.results-section {
    text-align: center;
}

.score-display {
    margin: 30px 0;
}

.score-number {
    font-size: 48px;
    font-weight: bold;
    color: var(--primary-color);
}

.achievement-unlocked {
    margin: 20px 0;
    padding: 20px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 8px;
}

.action-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const difficultySection = document.getElementById('difficultySelection');
    const questionSection = document.querySelector('.question-section');
    const difficultyButtons = document.querySelectorAll('.btn-difficulty');
    const difficultyDisplay = document.querySelector('.difficulty-display');
    const selectedDifficultyInput = document.getElementById('selectedDifficulty');
    const quizForm = document.getElementById('quizForm');
    const nextButton = document.getElementById('nextQuestion');
    const prevButton = document.getElementById('prevQuestion');
    const submitButton = document.getElementById('submitQuiz');
    const questionContainers = document.querySelectorAll('.question-container');
    const progressBar = document.querySelector('.progress');
    const questionCounter = document.querySelector('.question-counter');
    const currentScore = document.querySelector('.current-score');

    let currentQuestion = 0;
    const totalQuestions = questionContainers.length;
    let score = 0;

    // Difficulty Selection Handler
    difficultyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const difficulty = this.dataset.difficulty;
            selectedDifficultyInput.value = difficulty;
            difficultySection.style.display = 'none';
            questionSection.style.display = 'block';
            difficultyDisplay.textContent = `Schwierigkeit: ${difficulty}`;
            updateNavigation();
        });
    });

    function updateNavigation() {
        // Update Progress
        const progress = ((currentQuestion + 1) / totalQuestions) * 100;
        progressBar.style.width = `${progress}%`;
        questionCounter.textContent = `Frage ${currentQuestion + 1}/${totalQuestions}`;

        // Show/Hide Questions
        questionContainers.forEach((q, index) => {
            q.style.display = index === currentQuestion ? 'block' : 'none';
        });

        // Update Navigation Buttons
        prevButton.style.display = currentQuestion > 0 ? 'block' : 'none';
        nextButton.style.display = currentQuestion < totalQuestions - 1 ? 'block' : 'none';
        submitButton.style.display = currentQuestion === totalQuestions - 1 ? 'block' : 'none';
    }

    function checkAnswer(questionIndex) {
        const selectedAnswer = document.querySelector(`input[name="answer${questionIndex}"]:checked`);
        const correctAnswer = document.querySelector(`input[name="correct${questionIndex}"]`).value;

        if (selectedAnswer) {
            const allOptions = document.querySelectorAll(`input[name="answer${questionIndex}"]`);
            allOptions.forEach(option => {
                const optionDiv = option.closest('.answer-option');
                if (option.value === correctAnswer) {
                    optionDiv.classList.add('correct');
                } else if (option === selectedAnswer) {
                    optionDiv.classList.add('incorrect');
                }
                option.disabled = true;
            });

            // Verz√∂gere den √úbergang zur n√§chsten Frage um 1,5 Sekunden
            if (currentQuestion < totalQuestions - 1) {
                setTimeout(() => {
                    currentQuestion++;
                    updateNavigation();
                    // Entferne die Markierungen f√ºr die n√§chste Frage
                    const nextOptions = document.querySelectorAll(`input[name="answer${currentQuestion}"]`);
                    nextOptions.forEach(option => {
                        const optionDiv = option.closest('.answer-option');
                        optionDiv.classList.remove('correct', 'incorrect');
                        option.disabled = false;
                    });
                }, 1500);
            }
            return option.value === correctAnswer;
        }
        return false;
    }

    // Navigation Handlers
    nextButton?.addEventListener('click', function() {
        const currentRadio = document.querySelector(`input[name="answer${currentQuestion}"]:checked`);
        if (!currentRadio) {
            alert('Bitte w√§hle eine Antwort aus.');
            return;
        }
        checkAnswer(currentQuestion);
    });

    prevButton?.addEventListener('click', function() {
        if (currentQuestion > 0) {
            currentQuestion--;
            updateNavigation();
        }
    });

    // Quiz Submission Handler
    quizForm?.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(quizForm);

        fetch(`{{ url_for('submit_quiz', movie_id=movie.id) }}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.querySelector('.question-section').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            document.querySelector('.score-number').textContent = data.score;

            // Achievement Check
            if (data.achievements?.length > 0) {
                const achievementSection = document.querySelector('.achievement-unlocked');
                achievementSection.style.display = 'block';
                achievementSection.querySelector('.achievement-name').textContent =
                    data.achievements.map(a => a.title).join(', ');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten. Bitte versuche es erneut.');
        });
    });
});
</script>
{% endblock %}
